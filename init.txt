view_delay = 0
use_animations =
clear_messages = true
travel_delay = -1
explore_delay = -1
travel_key_stop = false
default_manual_training = true
autopickup_no_burden = false
auto_exclude =
hp_warning = 0
show_more = false
show_newturn_mark = false
list_rotten = false
force_more_message =
show_travel_trail = false
skill_focus = false
autoinscribe += slay:mikee
flush.failure = false
char_set = ascii
cset = cloud:xa4
cset = item_orb:0
use_fake_player_cursor = true
equip_unequip = true

dump_order = header,hiscore,stats,misc,mutations,skills,spells,inventory
dump_order += overview
dump_order += messages,screenshot,monlist,kills,notes,vaults,action_counts
ood_interesting = 6
note_hp_percent = 25
note_skill_levels = 1,3,6,9,12,15,18,21,24,27
note_all_spells = true

# TBD...
fire_order = launcher, rock, javelin, tomahawk

####################################
# not sure exactly how important or correct these settings are

explore_stop =
explore_stop += items,branches,portals,stairs,altars
explore_stop += greedy_visited_item_stack,greedy_pickup_smart

stop := runrest_stop_message
ignore := runrest_ignore_message
stop =
ignore =
ignore += .*

runrest_ignore_poison = 3:15
runrest_ignore_monster += butterfly:1
runrest_ignore_monster += orb of destruction:1

####################################
# These keys are useful to answer prompts and aren't critical for manual play

bindkey = [Y] CMD_NO_CMD_DEFAULT
bindkey = [N] CMD_NO_CMD_DEFAULT
bindkey = [B] CMD_NO_CMD_DEFAULT
bindkey = [.] CMD_NO_CMD_DEFAULT

####################################
# Don't get interrupted!
: chk_interrupt_activity["blurry vision"] = function (iname, cause, extra)
:   return nil
: end

####################################
# autopickup/drop_filter stuff, just used for scrolls/potions/wands

autopickup = ?!/

ae := autopickup_exceptions
df := drop_filter
ae =
df =
# keep: identify,teleportation,remove curse,enchant weapon,
#       enchant armour,acquirement,recharging,holy word
ae += scrolls? of (summoning|vulnerability|brand weapon)
ae += scrolls? of (magic mapping|fog|fear|silence)
ae += scrolls? of (blinking|amnesia)
ae += scrolls? of (curse armour|curse jewellery|curse weapon)
ae += scrolls? of (immolation|noise|random uselessness|torment)
df += scrolls? of (summoning|vulnerability|brand weapon)
df += scrolls? of (magic mapping|fog|fear|silence)
df += scrolls? of (blinking|amnesia)
df += scrolls? of (curse armour|curse jewellery|curse weapon)
df += scrolls? of (immolation|noise|random uselessness|torment)
# keep: curing,heal wounds,haste,cancellation,resistance,experience,
#       might,beneficial mutation,cure mutation,restore abilities
ae += potions? of (brilliance|magic|berserk rage)
ae += potions? of (flight|invisibility|agility)
ae += potions? of (ambrosia|decay|degeneration|mutation)
ae += potions? of (poison|lignification)
df += potions? of (brilliance|magic|berserk rage)
df += potions? of (flight|invisibility|agility)
df += potions? of (ambrosia|decay|degeneration|mutation)
df += potions? of (poison|lignification)
: if you.race() ~= "Vampire" then
ae += potions? of blood
df += potions? of blood
: end
# keep: heal wounds,hasting,teleportation
ae += wand of (random effects|slowing|magic darts|flame|frost|confusion)
ae += wand of (enslavement|paralysis|invisibility|lightning|fireball)
ae += wand of (cold|digging|disintegration|draining|fire|polymorph)
df += wand of (random effects|slowing|magic darts|flame|frost|confusion)
df += wand of (enslavement|paralysis|invisibility|lightning|fireball)
df += wand of (cold|digging|disintegration|draining|fire|polymorph)

################################################################
# now the lua

{

local LOS = 7

local main_actions = {
  try_rest,
  try_relax,
  try_explore,
  try_progress,
  try_fight,
  escape,
  panic}

-- Resting is what we do when we're not in danager to get us into a state
-- suitable for adventuring in. At its most basic, it is waiting for health
-- and mana to regenerate. Advanced techniques might include casting regeneration
-- on yourself, healing yourself as a deep dwarf, or sif channeling as a mummy.

function try_rest()
  if danger() then
     return false
  end

  local hp,mhp = you.hp()
  if hp < mhp then
    rest()
    return true
  end

  local mp,mmp = you.mp()
  if mp < mmp then
    rest()
    return true
  end

  return false
end
main_actions[1] = try_rest

function rest()
  say("Resting!")
  do_it("s")
end

-- Relaxing is what we do when we're not in danager and we're in a healthy state
-- in order to increase our readiness for what lies ahead. This is mainly memorizing
-- new spells and eating, but also includes things such as quaff IDing.

function try_relax()
  return false
end
main_actions[2] = try_relax

-- Exploring is how we go looking for trouble and treasure on the dungeon level
-- we're currently located on. Here we make use of the robust auto explore
-- functionality that is built into crawl.

function explore()
  if danger() then
     return false
  end

  try_it("o")
  try_it("j")

--[[
  if do_it("j") then
    say("Exploring!")
    return true
  else
    say("Exploring failed. Level likely explored.")
    return false
  end
--]]
  return false
end
main_actions[3] = explore

-- Progressing is how we advance in the game. At its most basic it's taking a down
-- stairway. This controls interlevel travel in general, and the rob run specifically.

function try_progress()
  return false
end
main_actions[4] = try_progress

-- When we're in too much danger to rest, relax, explore or progress, then we will try
-- and fight. Of course this segment will take up most of the code.

local fight_actions = {
  whack,
  shoot,
  kite,
  wait}

function try_fight()
  return false
end
main_actions[5] = try_fight

-- When even fighting would be too dangerous, we will try to escape this emergency.
-- The typical means of doing this is teleportation, but there are other possilibites.

function escape()
  return false
end
main_actions[6] = escape

-- Should never be reached???

function panic()
  say("CB doesn't know what to do! Panicing.")
  return true
end
main_actions[7] = panic

-- Utility functions.

local monster_array
local monster_array_init = false

function initialize_monster_array()
  if not monster_array_init then
    monster_array = {}
    local x
    for x = -LOS,LOS do
      monster_array[x] = {}
    end
    monster_array_init = true
    say("Initializing monster array")
  end
end

function update_monster_array()
  initialize_monster_array()

  local x,y
  for x = -LOS,LOS do
    for y = -LOS,LOS do
      monster_array[x][y] = monster.get_monster_at(x, y)
    end
  end
end

function danger()
  update_monster_array()

  local danger = false

  for x = -LOS,LOS do
    for y = -LOS,LOS do
      if monster_array[x][y] then
        danger = true
      end
    end
  end

  return danger
end

function say(x)
  crawl.mpr(x)
  crawl.take_note(x)
end

local old_turn

function try_it(command)
  old_turn = you.turns()
  crawl.process_keys(command)
  return you.turn_is_over()
end

-- Run when crawl is ready for user input.
function ready

-- Entry points.


-- Run when you hit tab
function hit_closest()
  local result = false
  local n = 1
  while result == false do
    result = main_actions[n]()
    n = n + 1
  end
end

-- Run when crawl is deciding if it should pick something up.
function autopickup(it, name)
  return true
end
clear_autopickup_funcs()
add_autopickup_func(autopickup)


}
